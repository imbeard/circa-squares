const { builder } = require("@netlify/functions");
const chromium = require("chrome-aws-lambda");

function isFullUrl(url) {
  try {
    new URL(url);
    return true;
  } catch(e) {
    // invalid url OR local path
    return false;
  }
}

async function screenshot(url, { format, viewport, dpr = 1, withJs = true, wait, timeout = 8500 }) {
  // Must be between 3000 and 8500
  timeout = Math.min(Math.max(timeout, 3000), 8500);

  const browser = await chromium.puppeteer.launch({
    executablePath: await chromium.executablePath,
    args: chromium.args,
    defaultViewport: {
      width: viewport[0],
      height: viewport[1],
      deviceScaleFactor: parseFloat(dpr),
    },
    headless: chromium.headless,
  });

  const page = await browser.newPage();

  if(!withJs) {
    page.setJavaScriptEnabled(false);
  }

  let response = await Promise.race([
    page.goto(url, {
      waitUntil: wait || ["load"],
      timeout,
    }),
    new Promise(resolve => {
      setTimeout(() => {
        resolve(false); // false is expected below
      }, timeout - 1500); // we need time to execute the window.stop before the top level timeout hits
    }),
  ]);

  if(response === false) { // timed out, resolved false
    await page.evaluate(() => window.stop());
  }

  // let statusCode = response.status();
  // TODO handle 4xx/5xx status codes better

  let options = {
    type: format,
    encoding: "base64",
    fullPage: false,
    captureBeyondViewport: false,
    clip: {
      x: 0,
      y: 0,
      width: viewport[0],
      height: viewport[1],
    }
  };

  if(format === "jpeg") {
    options.quality = 80;
  }

  let output = await page.screenshot(options);

  await browser.close();

  return output;
}

// Based on https://github.com/DavidWells/netlify-functions-workshop/blob/master/lessons-code-complete/use-cases/13-returning-dynamic-images/functions/return-image.js
async function handler(event, context) {
  // e.g. /https%3A%2F%2Fwww.11ty.dev%2F/small/1:1/smaller/
  let pathSplit = event.path.split("/").filter(entry => !!entry);
  let [url, size, aspectratio, zoom, cachebuster] = pathSplit;
  let format = "jpeg"; // hardcoded for now, but png and webp are supported!
  let viewport = [];

  // Manage your own frequency by using a _ prefix and then a hash buster string after your URL
  // e.g. /https%3A%2F%2Fwww.11ty.dev%2F/_20210802/ and set this to today’s date when you deploy
  if(size && size.startsWith("_")) {
    cachebuster = size;
    size = undefined;
  }
  if(aspectratio && aspectratio.startsWith("_")) {
    cachebuster = aspectratio;
    aspectratio = undefined;
  }
  if(zoom && zoom.startsWith("_")) {
    cachebuster = zoom;
    zoom = undefined;
  }

  // Options
  let pathOptions = {};
  let optionsMatch = (cachebuster || "").split("_").filter(entry => !!entry);
  for(let o of optionsMatch) {
    let [key, value] = o.split(":");
    pathOptions[key.toLowerCase()] = parseInt(value, 10);
  }

  let wait = ["load"];
  if(pathOptions.wait === 0) {
    wait = ["domcontentloaded"];
  } else if(pathOptions.wait === 1) {
    wait = ["load"];
  } else if(pathOptions.wait === 2) {
    wait = ["load", "networkidle0"];
  } else if(pathOptions.wait === 3) {
    wait = ["load", "networkidle2"];
  }

  let timeout;
  if(pathOptions.timeout) {
    timeout = pathOptions.timeout * 1000;
  }

  // Set Defaults
  format = format || "jpeg";
  aspectratio = aspectratio || "1:1";
  size = size || "small";
  zoom = zoom || "standard";

  let dpr;
  if(zoom === "bigger") {
    dpr = 1.4;
  } else if(zoom === "smaller") {
    dpr = 0.71428571;
  } else if(zoom === "standard") {
    dpr = 1;
  }

  if(size === "small") {
    if(aspectratio === "1:1") {
      viewport = [375, 375];
    } else if(aspectratio === "9:16") {
      viewport = [375, 667];
    }
  } else if(size === "medium") {
    if(aspectratio === "1:1") {
      viewport = [650, 650];
    } else if(aspectratio === "9:16") {
      viewport = [650, 1156];
    }
  } else if(size === "large") {
    // 0.5625 aspect ratio not supported on large
    if(aspectratio === "1:1") {
      viewport = [1024, 1024];
    }
  } else if(size === "opengraph") {
    // ignores aspectratio
    // always maintain a 1200×630 output image
    if(zoom === "bigger") { // dpr = 1.4
      viewport = [857, 450];
    } else if(zoom === "smaller") { // dpr = 0.714
      viewport = [1680, 882];
    } else {
      viewport = [1200, 630];
    }
  }

  url = decodeURIComponent(url);

  try {
    if(!isFullUrl(url)) {
      throw new Error(`Invalid \`url\`: ${url}`);
    }

    if(!viewport || viewport.length !== 2) {
      throw new Error("Incorrect API usage. Expects one of: /:url/ or /:url/:size/ or /:url/:size/:aspectratio/")
    }

    let output = await screenshot(url, {
      format,
      viewport,
      dpr,
      wait,
      timeout,
    });

    // output to Function logs
    console.log(url, format, { viewport }, { size }, { dpr }, { aspectratio });

    return {
      statusCode: 200,
      headers: {
        "content-type": `image/${format}`
      },
      body: output,
      isBase64Encoded: true
    };
  } catch (error) {
    console.log("Error", error);

    return {
      // We need to return 200 here or Firefox won’t display the image
      // HOWEVER a 200 means that if it times out on the first attempt it will stay the default image until the next build.
      statusCode: 200,
      // HOWEVER HOWEVER, we can set a ttl of 3600 which means that the image will be re-requested in an hour.
      ttl: 3600,
      headers: {
        "content-type": "image/svg+xml",
        "x-error-message": error.message
      },
      body: `<svg width="1481" height="1127" viewBox="0 0 1481 1127" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M161 160.8V198.8H188.6C192.333 198.8 194.2 200.133 194.2 202.8C194.2 205.6 192.333 207 188.6 207H142C138.4 207 136.6 205.6 136.6 202.8C136.6 200.133 138.4 198.8 142 198.8H152.8V102.6H142C138.4 102.6 136.6 101.2 136.6 98.4C136.6 95.7333 138.4 94.4 142 94.4H190C200.667 94.4 209.6 97.6 216.8 104C224.133 110.267 227.8 118.067 227.8 127.4C227.8 136.733 223.867 144.667 216 151.2C208.133 157.6 198.533 160.8 187.2 160.8H161ZM161 152.6H187.8C196.467 152.6 203.933 150.133 210.2 145.2C216.467 140.267 219.6 134.333 219.6 127.4C219.6 120.6 216.733 114.8 211 110C205.4 105.067 198.667 102.6 190.8 102.6H161V152.6ZM280.922 156.8V198.8H295.922C299.522 198.8 301.322 200.133 301.322 202.8C301.322 205.6 299.522 207 295.922 207H261.922C258.322 207 256.522 205.6 256.522 202.8C256.522 200.133 258.322 198.8 261.922 198.8H272.722V102.6H261.922C258.322 102.6 256.522 101.2 256.522 98.4C256.522 95.7333 258.322 94.4 261.922 94.4H311.522C321.255 94.4 329.655 97.5333 336.722 103.8C343.922 109.933 347.522 117.2 347.522 125.6C347.522 138.533 338.255 148.2 319.722 154.6C325.989 158.867 331.255 163.733 335.522 169.2C339.789 174.667 345.989 184.533 354.122 198.8H360.322C363.922 198.8 365.722 200.133 365.722 202.8C365.722 205.6 363.922 207 360.322 207H348.922C340.122 190.733 332.855 179.2 327.122 172.4C321.522 165.467 314.922 160.267 307.322 156.8H280.922ZM280.922 148.6H303.722C313.589 148.6 321.989 146.333 328.922 141.8C335.855 137.267 339.322 131.8 339.322 125.4C339.322 119.4 336.455 114.133 330.722 109.6C325.122 104.933 318.722 102.6 311.522 102.6H280.922V148.6ZM400.844 152.6V198.8H463.644V175C463.644 171.4 465.044 169.6 467.844 169.6C470.51 169.6 471.844 171.4 471.844 175V207H381.844C378.244 207 376.444 205.6 376.444 202.8C376.444 200.133 378.244 198.8 381.844 198.8H392.644V102.6H381.844C378.244 102.6 376.444 101.2 376.444 98.4C376.444 95.7333 378.244 94.4 381.844 94.4H467.644V122.2C467.644 125.8 466.244 127.6 463.444 127.6C460.777 127.6 459.444 125.8 459.444 122.2V102.6H400.844V144.4H429.844V135.4C429.844 131.8 431.244 130 434.044 130C436.71 130 438.044 131.8 438.044 135.4V161.6C438.044 165.2 436.71 167 434.044 167C431.244 167 429.844 165.2 429.844 161.6V152.6H400.844ZM541.166 207L501.166 102.6H494.966C491.366 102.6 489.566 101.2 489.566 98.4C489.566 95.7333 491.366 94.4 494.966 94.4H525.166C528.766 94.4 530.566 95.7333 530.566 98.4C530.566 101.2 528.766 102.6 525.166 102.6H509.766L546.966 198.8H547.566L586.166 102.6H570.566C566.966 102.6 565.166 101.2 565.166 98.4C565.166 95.7333 566.966 94.4 570.566 94.4H600.566C604.166 94.4 605.966 95.7333 605.966 98.4C605.966 101.2 604.166 102.6 600.566 102.6H594.366L552.566 207H541.166ZM671.688 102.6V198.8H699.488C703.221 198.8 705.088 200.133 705.088 202.8C705.088 205.6 703.221 207 699.488 207H635.688C632.088 207 630.288 205.6 630.288 202.8C630.288 200.133 632.088 198.8 635.688 198.8H663.488V102.6H635.688C632.088 102.6 630.288 101.2 630.288 98.4C630.288 95.7333 632.088 94.4 635.688 94.4H699.488C703.221 94.4 705.088 95.7333 705.088 98.4C705.088 101.2 703.221 102.6 699.488 102.6H671.688ZM760.609 152.6V198.8H823.409V175C823.409 171.4 824.809 169.6 827.609 169.6C830.276 169.6 831.609 171.4 831.609 175V207H741.609C738.009 207 736.209 205.6 736.209 202.8C736.209 200.133 738.009 198.8 741.609 198.8H752.409V102.6H741.609C738.009 102.6 736.209 101.2 736.209 98.4C736.209 95.7333 738.009 94.4 741.609 94.4H827.409V122.2C827.409 125.8 826.009 127.6 823.209 127.6C820.543 127.6 819.209 125.8 819.209 122.2V102.6H760.609V144.4H789.609V135.4C789.609 131.8 791.009 130 793.809 130C796.476 130 797.809 131.8 797.809 135.4V161.6C797.809 165.2 796.476 167 793.809 167C791.009 167 789.609 165.2 789.609 161.6V152.6H760.609ZM871.931 207L859.931 102.6H856.931C853.331 102.6 851.531 101.2 851.531 98.4C851.531 95.7333 853.331 94.4 856.931 94.4H886.731C890.465 94.4 892.331 95.7333 892.331 98.4C892.331 101.2 890.465 102.6 886.731 102.6H868.131L879.331 197.8L901.731 119.4H914.131L935.931 197.8L947.331 102.6H928.131C924.531 102.6 922.731 101.2 922.731 98.4C922.731 95.7333 924.531 94.4 928.131 94.4H958.131C961.731 94.4 963.531 95.7333 963.531 98.4C963.531 101.2 961.731 102.6 958.131 102.6H955.131L942.731 207H929.931L907.531 127L884.531 207H871.931ZM192 302.6V398.8H219.8C223.533 398.8 225.4 400.133 225.4 402.8C225.4 405.6 223.533 407 219.8 407H156C152.4 407 150.6 405.6 150.6 402.8C150.6 400.133 152.4 398.8 156 398.8H183.8V302.6H156C152.4 302.6 150.6 301.2 150.6 298.4C150.6 295.733 152.4 294.4 156 294.4H219.8C223.533 294.4 225.4 295.733 225.4 298.4C225.4 301.2 223.533 302.6 219.8 302.6H192ZM313.122 373.2H303.922L272.122 302.6H270.522V398.8H285.322C289.055 398.8 290.922 400.133 290.922 402.8C290.922 405.6 289.055 407 285.322 407H255.522C251.922 407 250.122 405.6 250.122 402.8C250.122 400.133 251.922 398.8 255.522 398.8H262.322V302.6H257.322C253.722 302.6 251.922 301.2 251.922 298.4C251.922 295.733 253.722 294.4 257.322 294.4H277.122L308.522 364L339.322 294.4H359.322C362.922 294.4 364.722 295.733 364.722 298.4C364.722 301.2 362.922 302.6 359.322 302.6H354.322V398.8H361.122C364.722 398.8 366.522 400.133 366.522 402.8C366.522 405.6 364.722 407 361.122 407H331.322C327.722 407 325.922 405.6 325.922 402.8C325.922 400.133 327.722 398.8 331.322 398.8H346.122V302.6H344.522L313.122 373.2ZM453.444 369.4H400.244L389.444 398.8H405.244C408.844 398.8 410.644 400.133 410.644 402.8C410.644 405.6 408.844 407 405.244 407H375.044C371.444 407 369.644 405.6 369.644 402.8C369.644 400.133 371.444 398.8 375.044 398.8H381.244L417.044 302.6H393.044C389.444 302.6 387.644 301.2 387.644 298.4C387.644 295.733 389.444 294.4 393.044 294.4H433.844L473.244 398.8H480.644C484.244 398.8 486.044 400.133 486.044 402.8C486.044 405.6 484.244 407 480.644 407H449.444C445.844 407 444.044 405.6 444.044 402.8C444.044 400.133 445.844 398.8 449.444 398.8H464.644L453.444 369.4ZM450.444 361.2L428.044 302.6H425.044L403.444 361.2H450.444ZM550.766 300C542.499 300 535.366 301.8 529.366 305.4C523.366 309 518.966 313.4 516.166 318.6C513.499 323.8 511.566 328.533 510.366 332.8C509.166 337.067 508.566 340.667 508.566 343.6V358.2C508.566 371.8 512.699 382.533 520.966 390.4C529.232 398.133 540.566 402 554.966 402C564.299 402 573.832 399.733 583.566 395.2V365.2H555.766C552.166 365.2 550.366 363.8 550.366 361C550.366 358.333 552.166 357 555.766 357H594.566C598.299 357 600.166 358.333 600.166 361C600.166 363.8 598.299 365.2 594.566 365.2H591.766V399.8C579.766 406.733 567.299 410.2 554.366 410.2C537.966 410.2 524.832 405.467 514.966 396C505.232 386.533 500.366 373.933 500.366 358.2V343.4C500.366 329.4 505.032 317.333 514.366 307.2C523.832 296.933 535.832 291.8 550.366 291.8C563.566 291.8 574.632 295.4 583.566 302.6V299.8C583.566 296.2 584.966 294.4 587.766 294.4C590.432 294.4 591.766 296.2 591.766 299.8V318C591.766 321.6 590.432 323.4 587.766 323.4C585.232 323.4 583.899 321.733 583.766 318.4C583.366 313.333 579.966 309 573.566 305.4C567.166 301.8 559.566 300 550.766 300ZM640.688 352.6V398.8H703.488V375C703.488 371.4 704.888 369.6 707.688 369.6C710.354 369.6 711.688 371.4 711.688 375V407H621.688C618.088 407 616.288 405.6 616.288 402.8C616.288 400.133 618.088 398.8 621.688 398.8H632.488V302.6H621.688C618.088 302.6 616.288 301.2 616.288 298.4C616.288 295.733 618.088 294.4 621.688 294.4H707.488V322.2C707.488 325.8 706.088 327.6 703.288 327.6C700.621 327.6 699.288 325.8 699.288 322.2V302.6H640.688V344.4H669.688V335.4C669.688 331.8 671.088 330 673.888 330C676.554 330 677.888 331.8 677.888 335.4V361.6C677.888 365.2 676.554 367 673.888 367C671.088 367 669.688 365.2 669.688 361.6V352.6H640.688ZM871.931 407L859.931 302.6H856.931C853.331 302.6 851.531 301.2 851.531 298.4C851.531 295.733 853.331 294.4 856.931 294.4H886.731C890.465 294.4 892.331 295.733 892.331 298.4C892.331 301.2 890.465 302.6 886.731 302.6H868.131L879.331 397.8L901.731 319.4H914.131L935.931 397.8L947.331 302.6H928.131C924.531 302.6 922.731 301.2 922.731 298.4C922.731 295.733 924.531 294.4 928.131 294.4H958.131C961.731 294.4 963.531 295.733 963.531 298.4C963.531 301.2 961.731 302.6 958.131 302.6H955.131L942.731 407H929.931L907.531 327L884.531 407H871.931ZM1031.45 302.6V398.8H1059.25C1062.99 398.8 1064.85 400.133 1064.85 402.8C1064.85 405.6 1062.99 407 1059.25 407H995.453C991.853 407 990.053 405.6 990.053 402.8C990.053 400.133 991.853 398.8 995.453 398.8H1023.25V302.6H995.453C991.853 302.6 990.053 301.2 990.053 298.4C990.053 295.733 991.853 294.4 995.453 294.4H1059.25C1062.99 294.4 1064.85 295.733 1064.85 298.4C1064.85 301.2 1062.99 302.6 1059.25 302.6H1031.45ZM1132.78 302.6V398.8H1187.38V366.8C1187.38 363.2 1188.78 361.4 1191.58 361.4C1194.24 361.4 1195.58 363.2 1195.58 366.8V407H1105.38C1101.78 407 1099.98 405.6 1099.98 402.8C1099.98 400.133 1101.78 398.8 1105.38 398.8H1124.58V302.6H1105.38C1101.78 302.6 1099.98 301.2 1099.98 298.4C1099.98 295.733 1101.78 294.4 1105.38 294.4H1151.98C1155.58 294.4 1157.38 295.733 1157.38 298.4C1157.38 301.2 1155.58 302.6 1151.98 302.6H1132.78ZM1252.7 302.6V398.8H1307.3V366.8C1307.3 363.2 1308.7 361.4 1311.5 361.4C1314.16 361.4 1315.5 363.2 1315.5 366.8V407H1225.3C1221.7 407 1219.9 405.6 1219.9 402.8C1219.9 400.133 1221.7 398.8 1225.3 398.8H1244.5V302.6H1225.3C1221.7 302.6 1219.9 301.2 1219.9 298.4C1219.9 295.733 1221.7 294.4 1225.3 294.4H1271.9C1275.5 294.4 1277.3 295.733 1277.3 298.4C1277.3 301.2 1275.5 302.6 1271.9 302.6H1252.7ZM148.8 598.8V502.6H142C138.4 502.6 136.6 501.2 136.6 498.4C136.6 495.733 138.4 494.4 142 494.4H186C198.933 494.4 209.8 499.333 218.6 509.2C227.533 518.933 232 530.867 232 545V556.2C232 570.467 227.533 582.533 218.6 592.4C209.8 602.133 198.933 607 186 607H142C138.4 607 136.6 605.6 136.6 602.8C136.6 600.133 138.4 598.8 142 598.8H148.8ZM223.8 543.4C223.8 540.733 223.2 537.4 222 533.4C220.8 529.4 218.867 525 216.2 520.2C213.667 515.267 209.667 511.133 204.2 507.8C198.867 504.333 192.667 502.6 185.6 502.6H157V598.8H187C196.6 598.8 205.133 594.667 212.6 586.4C220.067 578.133 223.8 568.667 223.8 558V543.4ZM311.922 502.6V598.8H339.722C343.455 598.8 345.322 600.133 345.322 602.8C345.322 605.6 343.455 607 339.722 607H275.922C272.322 607 270.522 605.6 270.522 602.8C270.522 600.133 272.322 598.8 275.922 598.8H303.722V502.6H275.922C272.322 502.6 270.522 501.2 270.522 498.4C270.522 495.733 272.322 494.4 275.922 494.4H339.722C343.455 494.4 345.322 495.733 345.322 498.4C345.322 501.2 343.455 502.6 339.722 502.6H311.922ZM460.644 576.4C460.644 570.8 458.91 566.267 455.444 562.8C451.977 559.333 447.644 557.067 442.444 556C437.377 554.8 431.777 553.533 425.644 552.2C419.644 550.733 414.044 549.267 408.844 547.8C403.777 546.2 399.51 543.333 396.044 539.2C392.577 534.933 390.844 529.467 390.844 522.8C390.844 514 394.31 506.667 401.244 500.8C408.31 494.8 417.11 491.8 427.644 491.8C439.11 491.8 448.844 495.733 456.844 503.6V499.8C456.844 496.2 458.244 494.4 461.044 494.4C463.71 494.4 465.044 496.2 465.044 499.8V520.4C465.044 524 463.71 525.8 461.044 525.8C458.377 525.8 456.977 524.2 456.844 521C456.444 515 453.51 510 448.044 506C442.577 502 435.977 500 428.244 500C419.977 500 413.11 502.2 407.644 506.6C402.31 511 399.644 516.467 399.644 523C399.644 528.2 401.377 532.4 404.844 535.6C408.31 538.8 412.577 541 417.644 542.2C422.844 543.267 428.444 544.6 434.444 546.2C440.577 547.667 446.177 549.2 451.244 550.8C456.444 552.4 460.777 555.467 464.244 560C467.71 564.4 469.444 570 469.444 576.8C469.444 586.533 465.577 594.533 457.844 600.8C450.11 607.067 440.244 610.2 428.244 610.2C414.11 610.2 402.844 605.4 394.444 595.8V601.6C394.444 605.2 393.044 607 390.244 607C387.577 607 386.244 605.2 386.244 601.6V579.2C386.244 575.6 387.644 573.8 390.444 573.8C392.977 573.8 394.31 575.4 394.444 578.6C394.71 585.133 398.11 590.667 404.644 595.2C411.177 599.733 418.977 602 428.044 602C437.377 602 445.11 599.6 451.244 594.8C457.51 589.867 460.644 583.733 460.644 576.4ZM520.766 560.8V598.8H548.366C552.099 598.8 553.966 600.133 553.966 602.8C553.966 605.6 552.099 607 548.366 607H501.766C498.166 607 496.366 605.6 496.366 602.8C496.366 600.133 498.166 598.8 501.766 598.8H512.566V502.6H501.766C498.166 502.6 496.366 501.2 496.366 498.4C496.366 495.733 498.166 494.4 501.766 494.4H549.766C560.432 494.4 569.366 497.6 576.566 504C583.899 510.267 587.566 518.067 587.566 527.4C587.566 536.733 583.632 544.667 575.766 551.2C567.899 557.6 558.299 560.8 546.966 560.8H520.766ZM520.766 552.6H547.566C556.232 552.6 563.699 550.133 569.966 545.2C576.232 540.267 579.366 534.333 579.366 527.4C579.366 520.6 576.499 514.8 570.766 510C565.166 505.067 558.432 502.6 550.566 502.6H520.766V552.6ZM653.088 502.6V598.8H707.688V566.8C707.688 563.2 709.088 561.4 711.888 561.4C714.554 561.4 715.888 563.2 715.888 566.8V607H625.688C622.088 607 620.288 605.6 620.288 602.8C620.288 600.133 622.088 598.8 625.688 598.8H644.888V502.6H625.688C622.088 502.6 620.288 501.2 620.288 498.4C620.288 495.733 622.088 494.4 625.688 494.4H672.288C675.888 494.4 677.688 495.733 677.688 498.4C677.688 501.2 675.888 502.6 672.288 502.6H653.088ZM813.209 569.4H760.009L749.209 598.8H765.009C768.609 598.8 770.409 600.133 770.409 602.8C770.409 605.6 768.609 607 765.009 607H734.809C731.209 607 729.409 605.6 729.409 602.8C729.409 600.133 731.209 598.8 734.809 598.8H741.009L776.809 502.6H752.809C749.209 502.6 747.409 501.2 747.409 498.4C747.409 495.733 749.209 494.4 752.809 494.4H793.609L833.009 598.8H840.409C844.009 598.8 845.809 600.133 845.809 602.8C845.809 605.6 844.009 607 840.409 607H809.209C805.609 607 803.809 605.6 803.809 602.8C803.809 600.133 805.609 598.8 809.209 598.8H824.409L813.209 569.4ZM810.209 561.2L787.809 502.6H784.809L763.209 561.2H810.209ZM911.931 556.2V598.8H932.931C936.531 598.8 938.331 600.133 938.331 602.8C938.331 605.6 936.531 607 932.931 607H882.731C879.131 607 877.331 605.6 877.331 602.8C877.331 600.133 879.131 598.8 882.731 598.8H903.731V556.2L867.931 502.6H863.131C859.531 502.6 857.731 501.2 857.731 498.4C857.731 495.733 859.531 494.4 863.131 494.4H885.331C888.931 494.4 890.731 495.733 890.731 498.4C890.731 501.2 888.931 502.6 885.331 502.6H877.731L908.131 548L937.931 502.6H929.931C926.198 502.6 924.331 501.2 924.331 498.4C924.331 495.733 926.198 494.4 929.931 494.4H951.931C955.531 494.4 957.331 495.733 957.331 498.4C957.331 501.2 955.531 502.6 951.931 502.6H947.131L911.931 556.2ZM213.6 769.4H160.4L149.6 798.8H165.4C169 798.8 170.8 800.133 170.8 802.8C170.8 805.6 169 807 165.4 807H135.2C131.6 807 129.8 805.6 129.8 802.8C129.8 800.133 131.6 798.8 135.2 798.8H141.4L177.2 702.6H153.2C149.6 702.6 147.8 701.2 147.8 698.4C147.8 695.733 149.6 694.4 153.2 694.4H194L233.4 798.8H240.8C244.4 798.8 246.2 800.133 246.2 802.8C246.2 805.6 244.4 807 240.8 807H209.6C206 807 204.2 805.6 204.2 802.8C204.2 800.133 206 798.8 209.6 798.8H224.8L213.6 769.4ZM210.6 761.2L188.2 702.6H185.2L163.6 761.2H210.6ZM280.922 752.6V798.8H308.522C312.255 798.8 314.122 800.133 314.122 802.8C314.122 805.6 312.255 807 308.522 807H261.922C258.322 807 256.522 805.6 256.522 802.8C256.522 800.133 258.322 798.8 261.922 798.8H272.722V702.6H261.922C258.322 702.6 256.522 701.2 256.522 698.4C256.522 695.733 258.322 694.4 261.922 694.4H351.922V722.2C351.922 725.8 350.522 727.6 347.722 727.6C345.055 727.6 343.722 725.8 343.722 722.2V702.6H280.922V744.4H309.922V735.4C309.922 731.8 311.255 730 313.922 730C316.722 730 318.122 731.8 318.122 735.4V761.6C318.122 765.2 316.722 767 313.922 767C311.255 767 309.922 765.2 309.922 761.6V752.6H280.922ZM432.044 798.8H453.044C456.644 798.8 458.444 800.133 458.444 802.8C458.444 805.6 456.644 807 453.044 807H402.844C399.244 807 397.444 805.6 397.444 802.8C397.444 800.133 399.244 798.8 402.844 798.8H423.844V702.6H390.444V717.2C390.444 720.8 389.044 722.6 386.244 722.6C383.577 722.6 382.244 720.8 382.244 717.2V694.4H473.444V717.2C473.444 720.8 472.11 722.6 469.444 722.6C468.244 722.6 467.244 722.133 466.444 721.2C465.644 720.133 465.244 718.8 465.244 717.2V702.6H432.044V798.8ZM520.766 752.6V798.8H583.566V775C583.566 771.4 584.966 769.6 587.766 769.6C590.432 769.6 591.766 771.4 591.766 775V807H501.766C498.166 807 496.366 805.6 496.366 802.8C496.366 800.133 498.166 798.8 501.766 798.8H512.566V702.6H501.766C498.166 702.6 496.366 701.2 496.366 698.4C496.366 695.733 498.166 694.4 501.766 694.4H587.566V722.2C587.566 725.8 586.166 727.6 583.366 727.6C580.699 727.6 579.366 725.8 579.366 722.2V702.6H520.766V744.4H549.766V735.4C549.766 731.8 551.166 730 553.966 730C556.632 730 557.966 731.8 557.966 735.4V761.6C557.966 765.2 556.632 767 553.966 767C551.166 767 549.766 765.2 549.766 761.6V752.6H520.766ZM640.688 756.8V798.8H655.688C659.288 798.8 661.088 800.133 661.088 802.8C661.088 805.6 659.288 807 655.688 807H621.688C618.088 807 616.288 805.6 616.288 802.8C616.288 800.133 618.088 798.8 621.688 798.8H632.488V702.6H621.688C618.088 702.6 616.288 701.2 616.288 698.4C616.288 695.733 618.088 694.4 621.688 694.4H671.288C681.021 694.4 689.421 697.533 696.488 703.8C703.688 709.933 707.288 717.2 707.288 725.6C707.288 738.533 698.021 748.2 679.488 754.6C685.754 758.867 691.021 763.733 695.288 769.2C699.554 774.667 705.754 784.533 713.888 798.8H720.088C723.688 798.8 725.488 800.133 725.488 802.8C725.488 805.6 723.688 807 720.088 807H708.687C699.888 790.733 692.621 779.2 686.888 772.4C681.288 765.467 674.688 760.267 667.088 756.8H640.688ZM640.688 748.6H663.488C673.354 748.6 681.754 746.333 688.688 741.8C695.621 737.267 699.088 731.8 699.088 725.4C699.088 719.4 696.221 714.133 690.488 709.6C684.888 704.933 678.488 702.6 671.288 702.6H640.688V748.6ZM940.331 776.4C940.331 770.8 938.598 766.267 935.131 762.8C931.665 759.333 927.331 757.067 922.131 756C917.065 754.8 911.465 753.533 905.331 752.2C899.331 750.733 893.731 749.267 888.531 747.8C883.465 746.2 879.198 743.333 875.731 739.2C872.265 734.933 870.531 729.467 870.531 722.8C870.531 714 873.998 706.667 880.931 700.8C887.998 694.8 896.798 691.8 907.331 691.8C918.798 691.8 928.531 695.733 936.531 703.6V699.8C936.531 696.2 937.931 694.4 940.731 694.4C943.398 694.4 944.731 696.2 944.731 699.8V720.4C944.731 724 943.398 725.8 940.731 725.8C938.065 725.8 936.665 724.2 936.531 721C936.131 715 933.198 710 927.731 706C922.265 702 915.665 700 907.931 700C899.665 700 892.798 702.2 887.331 706.6C881.998 711 879.331 716.467 879.331 723C879.331 728.2 881.065 732.4 884.531 735.6C887.998 738.8 892.265 741 897.331 742.2C902.531 743.267 908.131 744.6 914.131 746.2C920.265 747.667 925.865 749.2 930.931 750.8C936.131 752.4 940.465 755.467 943.931 760C947.398 764.4 949.131 770 949.131 776.8C949.131 786.533 945.265 794.533 937.531 800.8C929.798 807.067 919.931 810.2 907.931 810.2C893.798 810.2 882.531 805.4 874.131 795.8V801.6C874.131 805.2 872.731 807 869.931 807C867.265 807 865.931 805.2 865.931 801.6V779.2C865.931 775.6 867.331 773.8 870.131 773.8C872.665 773.8 873.998 775.4 874.131 778.6C874.398 785.133 877.798 790.667 884.331 795.2C890.865 799.733 898.665 802 907.731 802C917.065 802 924.798 799.6 930.931 794.8C937.198 789.867 940.331 783.733 940.331 776.4ZM1053.05 769.4H999.853L989.053 798.8H1004.85C1008.45 798.8 1010.25 800.133 1010.25 802.8C1010.25 805.6 1008.45 807 1004.85 807H974.653C971.053 807 969.253 805.6 969.253 802.8C969.253 800.133 971.053 798.8 974.653 798.8H980.853L1016.65 702.6H992.653C989.053 702.6 987.253 701.2 987.253 698.4C987.253 695.733 989.053 694.4 992.653 694.4H1033.45L1072.85 798.8H1080.25C1083.85 798.8 1085.65 800.133 1085.65 802.8C1085.65 805.6 1083.85 807 1080.25 807H1049.05C1045.45 807 1043.65 805.6 1043.65 802.8C1043.65 800.133 1045.45 798.8 1049.05 798.8H1064.25L1053.05 769.4ZM1050.05 761.2L1027.65 702.6H1024.65L1003.05 761.2H1050.05ZM1140.78 807L1100.78 702.6H1094.58C1090.98 702.6 1089.18 701.2 1089.18 698.4C1089.18 695.733 1090.98 694.4 1094.58 694.4H1124.78C1128.38 694.4 1130.18 695.733 1130.18 698.4C1130.18 701.2 1128.38 702.6 1124.78 702.6H1109.38L1146.58 798.8H1147.18L1185.78 702.6H1170.18C1166.58 702.6 1164.78 701.2 1164.78 698.4C1164.78 695.733 1166.58 694.4 1170.18 694.4H1200.18C1203.78 694.4 1205.58 695.733 1205.58 698.4C1205.58 701.2 1203.78 702.6 1200.18 702.6H1193.98L1152.18 807H1140.78ZM1240.3 752.6V798.8H1303.1V775C1303.1 771.4 1304.5 769.6 1307.3 769.6C1309.96 769.6 1311.3 771.4 1311.3 775V807H1221.3C1217.7 807 1215.9 805.6 1215.9 802.8C1215.9 800.133 1217.7 798.8 1221.3 798.8H1232.1V702.6H1221.3C1217.7 702.6 1215.9 701.2 1215.9 698.4C1215.9 695.733 1217.7 694.4 1221.3 694.4H1307.1V722.2C1307.1 725.8 1305.7 727.6 1302.9 727.6C1300.23 727.6 1298.9 725.8 1298.9 722.2V702.6H1240.3V744.4H1269.3V735.4C1269.3 731.8 1270.7 730 1273.5 730C1276.16 730 1277.5 731.8 1277.5 735.4V761.6C1277.5 765.2 1276.16 767 1273.5 767C1270.7 767 1269.3 765.2 1269.3 761.6V752.6H1240.3ZM213.6 969.4H160.4L149.6 998.8H165.4C169 998.8 170.8 1000.13 170.8 1002.8C170.8 1005.6 169 1007 165.4 1007H135.2C131.6 1007 129.8 1005.6 129.8 1002.8C129.8 1000.13 131.6 998.8 135.2 998.8H141.4L177.2 902.6H153.2C149.6 902.6 147.8 901.2 147.8 898.4C147.8 895.733 149.6 894.4 153.2 894.4H194L233.4 998.8H240.8C244.4 998.8 246.2 1000.13 246.2 1002.8C246.2 1005.6 244.4 1007 240.8 1007H209.6C206 1007 204.2 1005.6 204.2 1002.8C204.2 1000.13 206 998.8 209.6 998.8H224.8L213.6 969.4ZM210.6 961.2L188.2 902.6H185.2L163.6 961.2H210.6ZM348.122 1007H337.722L276.722 906.2V998.8H291.722C295.322 998.8 297.122 1000.13 297.122 1002.8C297.122 1005.6 295.322 1007 291.722 1007H261.722C258.122 1007 256.322 1005.6 256.322 1002.8C256.322 1000.13 258.122 998.8 261.722 998.8H268.522V902.6H257.722C254.122 902.6 252.322 901.2 252.322 898.4C252.322 895.733 254.122 894.4 257.722 894.4H278.922L339.922 995.2V902.6H325.122C321.389 902.6 319.522 901.2 319.522 898.4C319.522 895.733 321.389 894.4 325.122 894.4H354.922C358.522 894.4 360.322 895.733 360.322 898.4C360.322 901.2 358.522 902.6 354.922 902.6H348.122V1007ZM388.644 998.8V902.6H381.844C378.244 902.6 376.444 901.2 376.444 898.4C376.444 895.733 378.244 894.4 381.844 894.4H425.844C438.777 894.4 449.644 899.333 458.444 909.2C467.377 918.933 471.844 930.867 471.844 945V956.2C471.844 970.467 467.377 982.533 458.444 992.4C449.644 1002.13 438.777 1007 425.844 1007H381.844C378.244 1007 376.444 1005.6 376.444 1002.8C376.444 1000.13 378.244 998.8 381.844 998.8H388.644ZM463.644 943.4C463.644 940.733 463.044 937.4 461.844 933.4C460.644 929.4 458.71 925 456.044 920.2C453.51 915.267 449.51 911.133 444.044 907.8C438.71 904.333 432.51 902.6 425.444 902.6H396.844V998.8H426.844C436.444 998.8 444.977 994.667 452.444 986.4C459.91 978.133 463.644 968.667 463.644 958V943.4ZM640.688 956.8V998.8H655.688C659.288 998.8 661.088 1000.13 661.088 1002.8C661.088 1005.6 659.288 1007 655.688 1007H621.688C618.088 1007 616.288 1005.6 616.288 1002.8C616.288 1000.13 618.088 998.8 621.688 998.8H632.488V902.6H621.688C618.088 902.6 616.288 901.2 616.288 898.4C616.288 895.733 618.088 894.4 621.688 894.4H671.288C681.021 894.4 689.421 897.533 696.488 903.8C703.688 909.933 707.288 917.2 707.288 925.6C707.288 938.533 698.021 948.2 679.488 954.6C685.754 958.867 691.021 963.733 695.288 969.2C699.554 974.667 705.754 984.533 713.888 998.8H720.088C723.688 998.8 725.488 1000.13 725.488 1002.8C725.488 1005.6 723.688 1007 720.088 1007H708.687C699.888 990.733 692.621 979.2 686.888 972.4C681.288 965.467 674.688 960.267 667.088 956.8H640.688ZM640.688 948.6H663.488C673.354 948.6 681.754 946.333 688.688 941.8C695.621 937.267 699.088 931.8 699.088 925.4C699.088 919.4 696.221 914.133 690.488 909.6C684.888 904.933 678.488 902.6 671.288 902.6H640.688V948.6ZM760.609 952.6V998.8H823.409V975C823.409 971.4 824.809 969.6 827.609 969.6C830.276 969.6 831.609 971.4 831.609 975V1007H741.609C738.009 1007 736.209 1005.6 736.209 1002.8C736.209 1000.13 738.009 998.8 741.609 998.8H752.409V902.6H741.609C738.009 902.6 736.209 901.2 736.209 898.4C736.209 895.733 738.009 894.4 741.609 894.4H827.409V922.2C827.409 925.8 826.009 927.6 823.209 927.6C820.543 927.6 819.209 925.8 819.209 922.2V902.6H760.609V944.4H789.609V935.4C789.609 931.8 791.009 930 793.809 930C796.476 930 797.809 931.8 797.809 935.4V961.6C797.809 965.2 796.476 967 793.809 967C791.009 967 789.609 965.2 789.609 961.6V952.6H760.609ZM880.531 952.6V998.8H908.131C911.865 998.8 913.731 1000.13 913.731 1002.8C913.731 1005.6 911.865 1007 908.131 1007H861.531C857.931 1007 856.131 1005.6 856.131 1002.8C856.131 1000.13 857.931 998.8 861.531 998.8H872.331V902.6H861.531C857.931 902.6 856.131 901.2 856.131 898.4C856.131 895.733 857.931 894.4 861.531 894.4H951.531V922.2C951.531 925.8 950.131 927.6 947.331 927.6C944.665 927.6 943.331 925.8 943.331 922.2V902.6H880.531V944.4H909.531V935.4C909.531 931.8 910.865 930 913.531 930C916.331 930 917.731 931.8 917.731 935.4V961.6C917.731 965.2 916.331 967 913.531 967C910.865 967 909.531 965.2 909.531 961.6V952.6H880.531ZM1000.45 956.8V998.8H1015.45C1019.05 998.8 1020.85 1000.13 1020.85 1002.8C1020.85 1005.6 1019.05 1007 1015.45 1007H981.453C977.853 1007 976.053 1005.6 976.053 1002.8C976.053 1000.13 977.853 998.8 981.453 998.8H992.253V902.6H981.453C977.853 902.6 976.053 901.2 976.053 898.4C976.053 895.733 977.853 894.4 981.453 894.4H1031.05C1040.79 894.4 1049.19 897.533 1056.25 903.8C1063.45 909.933 1067.05 917.2 1067.05 925.6C1067.05 938.533 1057.79 948.2 1039.25 954.6C1045.52 958.867 1050.79 963.733 1055.05 969.2C1059.32 974.667 1065.52 984.533 1073.65 998.8H1079.85C1083.45 998.8 1085.25 1000.13 1085.25 1002.8C1085.25 1005.6 1083.45 1007 1079.85 1007H1068.45C1059.65 990.733 1052.39 979.2 1046.65 972.4C1041.05 965.467 1034.45 960.267 1026.85 956.8H1000.45ZM1000.45 948.6H1023.25C1033.12 948.6 1041.52 946.333 1048.45 941.8C1055.39 937.267 1058.85 931.8 1058.85 925.4C1058.85 919.4 1055.99 914.133 1050.25 909.6C1044.65 904.933 1038.25 902.6 1031.05 902.6H1000.45V948.6ZM1120.38 952.6V998.8H1183.18V975C1183.18 971.4 1184.58 969.6 1187.38 969.6C1190.04 969.6 1191.38 971.4 1191.38 975V1007H1101.38C1097.78 1007 1095.98 1005.6 1095.98 1002.8C1095.98 1000.13 1097.78 998.8 1101.38 998.8H1112.18V902.6H1101.38C1097.78 902.6 1095.98 901.2 1095.98 898.4C1095.98 895.733 1097.78 894.4 1101.38 894.4H1187.18V922.2C1187.18 925.8 1185.78 927.6 1182.98 927.6C1180.31 927.6 1178.98 925.8 1178.98 922.2V902.6H1120.38V944.4H1149.38V935.4C1149.38 931.8 1150.78 930 1153.58 930C1156.24 930 1157.58 931.8 1157.58 935.4V961.6C1157.58 965.2 1156.24 967 1153.58 967C1150.78 967 1149.38 965.2 1149.38 961.6V952.6H1120.38ZM1300.1 976.4C1300.1 970.8 1298.36 966.267 1294.9 962.8C1291.43 959.333 1287.1 957.067 1281.9 956C1276.83 954.8 1271.23 953.533 1265.1 952.2C1259.1 950.733 1253.5 949.267 1248.3 947.8C1243.23 946.2 1238.96 943.333 1235.5 939.2C1232.03 934.933 1230.3 929.467 1230.3 922.8C1230.3 914 1233.76 906.667 1240.7 900.8C1247.76 894.8 1256.56 891.8 1267.1 891.8C1278.56 891.8 1288.3 895.733 1296.3 903.6V899.8C1296.3 896.2 1297.7 894.4 1300.5 894.4C1303.16 894.4 1304.5 896.2 1304.5 899.8V920.4C1304.5 924 1303.16 925.8 1300.5 925.8C1297.83 925.8 1296.43 924.2 1296.3 921C1295.9 915 1292.96 910 1287.5 906C1282.03 902 1275.43 900 1267.7 900C1259.43 900 1252.56 902.2 1247.1 906.6C1241.76 911 1239.1 916.467 1239.1 923C1239.1 928.2 1240.83 932.4 1244.3 935.6C1247.76 938.8 1252.03 941 1257.1 942.2C1262.3 943.267 1267.9 944.6 1273.9 946.2C1280.03 947.667 1285.63 949.2 1290.7 950.8C1295.9 952.4 1300.23 955.467 1303.7 960C1307.16 964.4 1308.9 970 1308.9 976.8C1308.9 986.533 1305.03 994.533 1297.3 1000.8C1289.56 1007.07 1279.7 1010.2 1267.7 1010.2C1253.56 1010.2 1242.3 1005.4 1233.9 995.8V1001.6C1233.9 1005.2 1232.5 1007 1229.7 1007C1227.03 1007 1225.7 1005.2 1225.7 1001.6V979.2C1225.7 975.6 1227.1 973.8 1229.9 973.8C1232.43 973.8 1233.76 975.4 1233.9 978.6C1234.16 985.133 1237.56 990.667 1244.1 995.2C1250.63 999.733 1258.43 1002 1267.5 1002C1276.83 1002 1284.56 999.6 1290.7 994.8C1296.96 989.867 1300.1 983.733 1300.1 976.4ZM1414.62 952.6H1360.62V998.8H1371.42C1375.02 998.8 1376.82 1000.13 1376.82 1002.8C1376.82 1005.6 1375.02 1007 1371.42 1007H1343.42C1339.69 1007 1337.82 1005.6 1337.82 1002.8C1337.82 1000.13 1339.69 998.8 1343.42 998.8H1352.42V902.6H1347.42C1343.82 902.6 1342.02 901.2 1342.02 898.4C1342.02 895.733 1343.82 894.4 1347.42 894.4H1371.42C1375.02 894.4 1376.82 895.733 1376.82 898.4C1376.82 901.2 1375.02 902.6 1371.42 902.6H1360.62V944.4H1414.62V902.6H1403.82C1400.22 902.6 1398.42 901.2 1398.42 898.4C1398.42 895.733 1400.22 894.4 1403.82 894.4H1427.82C1431.42 894.4 1433.22 895.733 1433.22 898.4C1433.22 901.2 1431.42 902.6 1427.82 902.6H1422.82V998.8H1432.02C1435.62 998.8 1437.42 1000.13 1437.42 1002.8C1437.42 1005.6 1435.62 1007 1432.02 1007H1403.82C1400.22 1007 1398.42 1005.6 1398.42 1002.8C1398.42 1000.13 1400.22 998.8 1403.82 998.8H1414.62V952.6Z" fill="black"/></svg>`,
      isBase64Encoded: false,
    };
  }
}

exports.handler = builder(handler);
